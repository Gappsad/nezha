{{define "theme-server-status/home"}}
{{template "theme-server-status/header" .}}
<div id="app">
    {{template "theme-server-status/content-nav" .}}   

    <div @click="toggleView" class="toggleView">
        <i v-if="showGroup" class="show-nogroup bi bi-justify"></i>
        <i v-else="v-else" class="show-group bi bi-view-stacked"></i>
    </div>

    <!--  showGroup true -->
    <template v-if="showGroup">
        <div class="container table-responsive content" style="max-width: 95vw" v-for="group in nodesTag">
            {{template "theme-server-status/home-group-true" .}} 
        </div>
    </template>

    <!--  showGroup false -->
    <template v-else>
        <div class="container table-responsive content" style="max-width: 95vw">
            {{template "theme-server-status/home-group-false" .}}
        </div>
    </template>

    {{template "theme-server-status/content-footer" .}}
</div>

<script>
    new Vue({
        el: '#app',
        delimiters: ['@#', '#@'],
        data: {
            nodesTag: [],
            nodesNoTag: [],
            showGroup: false,
        },
        mixins: [mixinsVue],
        created() {
            const initData = JSON.parse('{{.Servers}}').servers;
            if(this.showGroup) {
                this.nodesTag = groupingData(this.handleNodes(initData),"Tag");
            } else {
                this.nodesNoTag = this.handleNodes(initData);
            }
            this.initTheme()
        },
        mounted() {
            this.connect();
        },
        methods: {
            toggleView() {
                this.showGroup = !this.showGroup;
                return this.showGroup;
            },
            isWindowsPlatform(str) {
                return str.includes('Windows')
            },
            getFontLogoClass(str) {
                if (["almalinux",
                        "alpine",
                        "aosc",
                        "apple",
                        "archlinux",
                        "archlabs",
                        "artix",
                        "budgie",
                        "centos",
                        "coreos",
                        "debian",
                        "deepin",
                        "devuan",
                        "docker",
                        "elementary",
                        "fedora",
                        "ferris",
                        "flathub",
                        "freebsd",
                        "gentoo",
                        "gnu-guix",
                        "illumos",
                        "kali-linux",
                        "linuxmint",
                        "mageia",
                        "mandriva",
                        "manjaro",
                        "nixos",
                        "openbsd",
                        "opensuse",
                        "pop-os",
                        "raspberry-pi",
                        "redhat",
                        "rocky-linux",
                        "sabayon",
                        "slackware",
                        "snappy",
                        "solus",
                        "tux",
                        "ubuntu",
                        "void",
                        "zorin"].indexOf(str)
                    > -1) {
                    return str;
                }
                if (['openwrt', 'linux', "immortalwrt"].indexOf(str) > -1) {
                    return 'tux';
                }
                if (str == 'amazon') {
                    return 'redhat';
                }
                if (str == 'arch') {
                    return 'archlinux';
                }
                return '';
            },
            secondToDate(s) {
                const d = Math.floor(s / 3600 / 24);
                if (d > 0) {
                    return d + ' {{tr "Day"}}'
                }
                const h = Math.floor(s / 3600 % 24);
                const m = Math.floor(s / 60 % 60);
                const second = Math.floor(s % 60);
                return h + ":" + ("0" + m).slice(-2) + ":" + ("0" + second).slice(-2);
            },
            formatTimestamp(t) {
                return new Date(t * 1000).toLocaleString()
            },
            formatByteSize(bs) {
                const x = this.readableBytes(bs)
                return x !== "NaN undefined" ? x : '0B'
            },
            formatPercent(live, used, total) {
                const percent = live ? (this.toFixed2(used / total * 100) || 0) : 0
                return this.formatPercents(percent)
            },
            formatPercents(percent) {
                if (percent <= 0) {
                    percent = 0;
                }
                if (!this.cache[percent]) {
                    this.cache[percent] = {
                        class: 'progress-bar progress-bar-success',
                        style: `width: ${parseInt(percent)+1}%`,
                        percent,
                    }
                    if (percent < 80) {
                        this.cache[percent].class = 'progress-bar progress-bar-success'
                    } else if (percent < 90) {
                        this.cache[percent].class = 'progress-bar progress-bar-warning'
                    } else {
                        this.cache[percent].class = 'progress-bar progress-bar-danger'
                    }
                }
                return this.cache[percent]
            },
            readableBytes(bytes) {
                if (!bytes) {
                    return '0B'
                }
                const i = Math.floor(Math.log(bytes) / Math.log(1024)),
                    sizes = ["B", "K", "M", "G", "T", "P", "E", "Z", "Y"];
                return parseFloat((bytes / Math.pow(1024, i)).toFixed(2)) + sizes[i];
            },
            connect() {
                const wsProtocol = window.location.protocol === "https:" ? "wss" : "ws"
                const ws = new WebSocket(wsProtocol + '://' + window.location.host + '/ws');
                ws.onopen = function () {
                    console.log("Connection open ...")
                }
                ws.onmessage = (evt) => {
                    let jsonData = evt.data
                    const data = JSON.parse(jsonData)
                    for (let i = 0; i < data.servers?.length; i++) {
                        const ns = data.servers[i];
                        if (!ns.Host) {
                            data.servers[i].live = false
                        } else {
                            const lastActive = new Date(ns.LastActive).getTime()
                            data.servers[i].live = data.now - lastActive <= 10 * 1000;
                        }
                    }
                    if(this.showGroup) {
                        this.nodesTag = groupingData(this.handleNodes(data.servers),"Tag");
                    } else {
                        this.nodesNoTag = this.handleNodes(data.servers);
                    }
                }
                ws.onclose = () => {
                    setTimeout(function () {
                        this.connect()
                    }, 5000);
                }
                ws.onerror = function () {
                    ws.close()
                }
            },
            handleNodes(servers) {
                let nodes = []
                servers?.forEach(server => {
                    let platform = server.Host.Platform;
                    if (this.isWindowsPlatform(platform)) {
                        platform = "windows"
                    }else if (platform === "immortalwrt") {
                        platform = "openwrt"
                    }
                    let node = {
                        ID: server.ID,
                        name: server.Name,
                        os: platform,
                        location: server.Host.CountryCode,
                        uptime: this.secondToDate(server.State.Uptime),
                        load: this.toFixed2(server.State.Load1),
                        network: this.getNetworkSpeed(server.State.NetInSpeed, server.State.NetOutSpeed),
                        traffic: this.formatByteSize(server.State.NetInTransfer) + ' | ' + this.formatByteSize(server.State.NetOutTransfer),
                        cpu: this.formatPercents(this.toFixed2(server.State.CPU)),
                        memory: this.formatPercent(server.live, server.State.MemUsed, server.Host.MemTotal),
                        hdd: this.formatPercent(server.live, server.State.DiskUsed, server.Host.DiskTotal),
                        online: server.live,
                        state: server.State,
                        host: server.Host,
                        lastActive: server.LastActive,
                        Tag: server.Tag,
                    }
                    nodes.push(node)
                })
                return nodes;
            },
            getNetworkSpeed(netInSpeed, netOutSpeed) {
                return this.formatByteSize(netInSpeed) + ' | ' + this.formatByteSize(netOutSpeed)
            }
        }

    })

    function groupingData(data, field) {
        let map = new Map();
        let dest = [];

        data.forEach(item => {
            if (!map.has(item[field])) {
                dest.push({
                    [field]: item[field],
                    data: [item]
                });
                map.set(item[field], item);
            } else {
                dest.find(dItem => dItem[field] === item[field]).data.push(item);
            }
        });

        return dest;
    }
</script>
{{template "theme-server-status/footer" .}}
{{end}}
